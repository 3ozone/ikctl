openapi: 3.0.3
info:
  title: ikctl API
  description: API REST para gestión de instalaciones remotas de aplicaciones vía SSH
  version: 1.0.0
  contact:
    name: ikctl Team
    email: support@ikctl.com

servers:
  - url: http://localhost:8000
    description: Desarrollo local
  - url: https://api.ikctl.com
    description: Producción

tags:
  - name: auth
    description: Autenticación y registro
  - name: users
    description: Gestión de perfil de usuario
  - name: password
    description: Recuperación de contraseña
  - name: 2fa
    description: Autenticación de dos factores

security:
  - BearerAuth: []

paths:
  /api/v1/register:
    post:
      tags: [auth]
      summary: Registro de nuevo usuario
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                  example: "Juan Pérez"
                email:
                  type: string
                  format: email
                  example: "juan@example.com"
                password:
                  type: string
                  format: password
                  example: "SecurePass123!"
                  description: "Mínimo 8 caracteres, 1 mayúscula, 1 minúscula, 1 número"
      responses:
        '201':
          description: Usuario creado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Usuario registrado. Verifica tu email."
                  user_id:
                    type: string
                    example: "user_123abc"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email ya registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/verify-email:
    post:
      tags: [auth]
      summary: Verificar email con token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Email verificado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Email verificado correctamente"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Token inválido o expirado

  /api/v1/resend-verification:
    post:
      tags: [auth]
      summary: Reenviar email de verificación
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "juan@example.com"
      responses:
        '200':
          description: Email reenviado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Email de verificación reenviado"
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/login:
    post:
      tags: [auth]
      summary: Login con email y contraseña
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                  description: Email del usuario
                  example: "juan@example.com"
                password:
                  type: string
                  format: password
                  example: "SecurePass123!"
      responses:
        '200':
          description: Login exitoso
          headers:
            Set-Cookie:
              description: Refresh token en HttpOnly cookie
              schema:
                type: string
                example: "refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800; Path=/api/v1"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Credenciales inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Usuario requiere verificación de email o 2FA
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Se requiere verificación de email"
                  requires_2fa:
                    type: boolean
                    example: false
                  temp_token:
                    type: string
                    description: Token temporal para completar 2FA

  /api/v1/login/github:
    post:
      tags: [auth]
      summary: Iniciar OAuth con GitHub
      security: []
      responses:
        '302':
          description: Redirección a GitHub OAuth
          headers:
            Location:
              schema:
                type: string
                example: "https://github.com/login/oauth/authorize?client_id=..."

  /api/v1/login/github/callback:
    get:
      tags: [auth]
      summary: Callback OAuth de GitHub
      security: []
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Login exitoso con GitHub
          headers:
            Set-Cookie:
              description: Refresh token en HttpOnly cookie
              schema:
                type: string
                example: "refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800; Path=/api/v1"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/login/2fa:
    post:
      tags: [2fa]
      summary: Completar login con código 2FA
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [temp_token, code]
              properties:
                temp_token:
                  type: string
                  description: Token temporal recibido tras login básico
                code:
                  type: string
                  example: "123456"
                  description: Código TOTP de 6 dígitos
      responses:
        '200':
          description: Login 2FA exitoso
          headers:
            Set-Cookie:
              description: Refresh token en HttpOnly cookie
              schema:
                type: string
                example: "refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800; Path=/api/v1"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/refresh:
    post:
      tags: [auth]
      summary: Refrescar access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token refrescado exitosamente
          headers:
            Set-Cookie:
              description: Nuevo refresh token en HttpOnly cookie
              schema:
                type: string
                example: "refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800; Path=/api/v1"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/logout:
    post:
      tags: [auth]
      summary: Cerrar sesión (invalidar refresh token)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: Logout exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Sesión cerrada correctamente"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/password/forgot:
    post:
      tags: [password]
      summary: Solicitar reset de contraseña
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "juan@example.com"
      responses:
        '200':
          description: Email enviado (respuesta genérica por seguridad)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Si el email existe, recibirás instrucciones de recuperación"
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/password/reset:
    post:
      tags: [password]
      summary: Restablecer contraseña con token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, new_password]
              properties:
                token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                new_password:
                  type: string
                  format: password
                  example: "NewSecurePass123!"
      responses:
        '200':
          description: Contraseña restablecida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Contraseña actualizada correctamente"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Token inválido o expirado

  /api/v1/users/me:
    get:
      tags: [users]
      summary: Obtener perfil del usuario autenticado
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags: [users]
      summary: Actualizar nombre del usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "Juan Carlos Pérez"
      responses:
        '200':
          description: Perfil actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/password:
    put:
      tags: [users]
      summary: Cambiar contraseña del usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [current_password, new_password]
              properties:
                current_password:
                  type: string
                  format: password
                  example: "OldPass123!"
                new_password:
                  type: string
                  format: password
                  example: "NewSecurePass123!"
      responses:
        '200':
          description: Contraseña actualizada
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Contraseña actualizada correctamente"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/2fa/enable:
    post:
      tags: [2fa]
      summary: Activar 2FA (genera QR code)
      responses:
        '200':
          description: 2FA iniciado, requiere verificación
          content:
            application/json:
              schema:
                type: object
                properties:
                  qr_code:
                    type: string
                    format: uri
                    example: "data:image/png;base64,iVBORw0KGgoAAAANS..."
                  secret:
                    type: string
                    example: "AB3DEFGHIJKLMNOP"
                  message:
                    type: string
                    example: "Escanea el QR y verifica el código"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/2fa/verify:
    post:
      tags: [2fa]
      summary: Verificar código 2FA para activar
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code:
                  type: string
                  example: "123456"
      responses:
        '200':
          description: 2FA activado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "2FA activado correctamente"
                  backup_codes:
                    type: array
                    items:
                      type: string
                    example: ["12345678", "87654321"]
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/users/me/2fa/disable:
    post:
      tags: [2fa]
      summary: Desactivar 2FA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [password]
              properties:
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: 2FA desactivado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "2FA desactivado correctamente"
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        refresh_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          example: "bearer"
        expires_in:
          type: integer
          example: 1800
          description: "Tiempo de expiración en segundos (30 minutos)"

    UserProfile:
      type: object
      properties:
        id:
          type: string
          example: "user_123abc"
        name:
          type: string
          example: "Juan Pérez"
        email:
          type: string
          format: email
          example: "juan@example.com"
        email_verified:
          type: boolean
          example: true
        two_factor_enabled:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
          example: "2026-02-14T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-14T12:45:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          example: "invalid_credentials"
        message:
          type: string
          example: "Credenciales inválidas"
        details:
          type: object
          additionalProperties: true

  responses:
    BadRequest:
      description: Petición inválida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: No autenticado o token inválido
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "unauthorized"
            message: "Token inválido o expirado"
